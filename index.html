<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <title>AI Squat Coach</title>
 <style>
  body {
    margin: 0;
    background: #000;
    overflow: hidden;
    font-family: sans-serif;
  }
  #container {
    position: relative;
    width: 100%;
    height: 100vh;
  }
  #webcam, #output {
    position: absolute;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  #counter {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 3em;
    color: #fff;
    text-shadow: 2px 2px 6px #000;
    z-index: 30;
  }
  .feedback {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    color: #fff;
    font-size: 1.4em;
    font-weight: bold;
    padding: 10px 18px;
    border-radius: 6px;
    text-shadow: 1px 1px 3px #000;
    max-width: 90%;
    white-space: nowrap;
    z-index: 35;
  }
  /* Πρώτη γραμμή: οδηγίες δράσης */
  #action {
    bottom: 25vh; /* Περίπου 25% του ύψους της οθόνης από κάτω */
    background: rgba(0, 102, 204, 0.85); /* Μπλε */
  }
  /* Δεύτερη γραμμή: τεχνική */
  #technique {
    bottom: 18vh; /* Περίπου 18% του ύψους της οθόνης από κάτω */
    background: rgba(0, 0, 0, 0.65); /* Σκούρο */
  }

  /* MEDIA QUERY: Εφαρμόζει στυλ για οθόνες με μέγιστο πλάτος 640px (μικρό iframe) */
  @media (max-width: 640px) {
    #action {
      bottom: 18vh;
      font-size: 0.9em; /* Μείωση μεγέθους γραμματοσειράς */
    }
    #technique {
      bottom: 12vh;
      font-size: 0.9em; /* Μείωση μεγέθους γραμματοσειράς */
    }
  }
</style>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
</head>
<body>
<div id="container">
  <video id="webcam" playsinline muted></video>
  <canvas id="output"></canvas>
  <div id="counter">0</div>
  <div id="action" class="feedback"></div>
  <div id="technique" class="feedback"></div>
</div>
<script>
const video=document.getElementById('webcam'),
      canvas=document.getElementById('output'),
      ctx=canvas.getContext('2d'),
      counter=document.getElementById('counter'),
      action=document.getElementById('action'),
      tech=document.getElementById('technique');
let detector,squatState="up",count=0;

function getAngle(a,b,c){
  const ab={x:a.x-b.x,y:a.y-b.y},cb={x:c.x-b.x,y:c.y-b.y};
  const dot=ab.x*cb.x+ab.y*cb.y;
  const magAB=Math.sqrt(ab.x**2+ab.y**2),magCB=Math.sqrt(cb.x**2+cb.y**2);
  return Math.acos(dot/(magAB*magCB))*180/Math.PI;
}

async function setupCam(){
  const s=await navigator.mediaDevices.getUserMedia({video:true});
  video.srcObject=s;
  return new Promise(r=>{video.onloadedmetadata=()=>{video.play();r(video);};});
}

async function loadModel(){
  detector=await poseDetection.createDetector(
    poseDetection.SupportedModels.MoveNet,
    {modelType:poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING}
  );
  detect();
}

function checkTechnique(kp){
  if(kp.length<17) return "Φανερώσου ολόκληρος στο κάδρο!";
  const lHip=kp[11],lKnee=kp[13],lAnkle=kp[15],
        rHip=kp[12],rKnee=kp[14],rAnkle=kp[16];
  if([lHip,lKnee,lAnkle,rHip,rKnee,rAnkle].some(p=>!p||p.score<0.4))
    return "Φανερώσου ολόκληρος στο κάδρο!";
  const kneeAngle=(getAngle(lHip,lKnee,lAnkle)+getAngle(rHip,rKnee,rAnkle))/2;
  if(kneeAngle>140) return "Κατέβα πιο χαμηλά";
  if(lKnee.x<lAnkle.x-20||rKnee.x>rAnkle.x+20) return "Μην κλείνεις τα γόνατα";
  return "Τέλεια τεχνική!";
}

async function detect(){
  const poses=await detector.estimatePoses(video);
  if(poses.length>0){
    const kp=poses[0].keypoints,
          lHip=kp[11],lKnee=kp[13],lAnkle=kp[15];
    if(lHip&&lKnee&&lAnkle&&lHip.score>0.4&&lKnee.score>0.4&&lAnkle.score>0.4){
      const angle=getAngle(lHip,lKnee,lAnkle);
      if(angle<100&&squatState==="up"){
        squatState="down";
        action.textContent="Κατέβα!";
      } else if(angle>160&&squatState==="down"){
        squatState="up";
        count++;
        counter.textContent=count;
        action.textContent="Ανέβα!";
      }
    }
    const tMsg=checkTechnique(kp);
    tech.textContent=tMsg;
    tech.style.background=tMsg==="Τέλεια τεχνική!"?"rgba(0,153,51,0.8)":"rgba(204,0,0,0.8)";
    ctx.clearRect(0,0,canvas.width,canvas.height);
    canvas.width=video.videoWidth;canvas.height=video.videoHeight;
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    for(let p of kp){if(p.score>0.4){ctx.fillStyle="yellow";ctx.beginPath();ctx.arc(p.x,p.y,5,0,2*Math.PI);ctx.fill();}}
  }
  requestAnimationFrame(detect);
}

setupCam();loadModel();
</script>
</body>
</html>
